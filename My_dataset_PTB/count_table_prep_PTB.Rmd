---
title: "PTBP1_counts"
author: "KN"
date: "2023-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/home/kate/github/GenomicsUA_2023_rnaseq/My_dataset_PTB")
setwd("/home/kate/github/GenomicsUA_2023_rnaseq/My_dataset_PTB")
```

```{r}
library(tidyverse)
library(org.Mm.eg.db)
library(biomaRt)
library(tximport)
```


```{r}

#upload metadata and count_table
metadata_table <- read.csv("ptb_metadata_table.csv")
counts_tsv <- "./counts_ptb.tsv"
if (file.exists(counts_tsv)){
    counts <- read_tsv(counts_tsv) 
}else{
    files <- fs::dir_ls(path = "./geo_inp", glob = "*quant.sf.txt")
    counts <- readr::read_tsv(files, id = "path", col_names = T, col_select = c("Name", "NumReads"))
    colnames(counts)<-c("path","ensembl_tr_id", "raw_counts")
    df_split <- str_split_fixed(counts$path, "_", 3) %>% as.data.frame()
    counts$sample <- df_split$V2 
    counts <- counts %>% 
        mutate(sample = str_replace(sample, "inp/", "")) %>% 
        dplyr::relocate(sample) %>% dplyr::select(-path) %>% 
        pivot_wider(names_from = "sample", values_from = "raw_counts")
    write.table(counts, counts_tsv, sep="\t", row.names = F)   
}

#remove low counts from analysis and rownames_to_column
counts <- counts[rowSums(counts[sapply(counts, is.numeric)]) > 10, ] 

#checking if unique
counts %>%unique() 
```


```{r}
#remove info after dot (remove version of transcropt ID)
counts$ensembl_tr_id <- gsub("\\.\\d+$", "", counts$ensembl_tr_id)

ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
listAttributes(ensembl)


biomart_list <- getBM(filter="ensembl_transcript_id",
                      attributes = c("ensembl_transcript_id", "mgi_symbol","transcript_biotype",
                                     "description"),
                      values = counts$ensembl_tr_id, mart = ensembl)
biomart_list <- subset(biomart_list, !is.na(mgi_symbol) & mgi_symbol != "")

unique(biomart_list$transcript_biotype)

counts_filtered <- counts %>% filter(ensembl_tr_id %in% biomart_list$ensembl_transcript_id)
```

```{r}
write.csv(counts_filtered, "outputs/counts_filtered.csv", row.names = FALSE)
write.csv(biomart_list, "outputs/biomart_list.csv", row.names = FALSE)
```

